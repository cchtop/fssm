<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>線上倉儲管理</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
body{font-family: system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC',sans-serif; margin:16px; line-height:1.5;}
h1{font-size:20px;margin:6px 0 12px}
fieldset{border:1px solid #ddd;border-radius:8px;margin:12px 0;padding:12px}
legend{padding:0 6px;color:#333}
label{display:inline-block;min-width:72px}
input,select,button{font-size:16px;padding:6px 8px;border:1px solid #c7c7c7;border-radius:6px}
button{background:#0d6efd;color:#fff;border:none}
button.secondary{background:#6c757d}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #e5e5e5;padding:6px 8px;font-size:14px}
th{background:#f7f7f7}
small.muted{color:#666}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="date"]{min-width:140px}
.kv{display:grid;grid-template-columns:100px 1fr;gap:6px 8px;align-items:center}
.bad{color:#b00020}
.good{color:#0a7}
#log{min-height:64px;width:100%;border:1px dashed #ddd;white-space:pre-wrap}
</style>
</head>
<body>
<h1>線上倉儲管理</h1>

<fieldset>
  <legend>API URL（GAS /exec）</legend>
  <div class="flex">
    <input id="apiUrl" style="min-width:320px" placeholder="貼上 Google Apps Script 部署的 /exec URL">
    <button id="btnPing">連線測試</button>
    <small class="muted">會儲存在瀏覽器，不會上傳。</small>
  </div>
</fieldset>

<fieldset>
  <legend>單筆新增 / 更新</legend>
  <div class="flex">
    <label>日期</label><input id="txDate" type="date">
    <label>條碼</label><input id="txBarcode" placeholder="掃描或輸入後 Enter">
    <label>料號</label><input id="txCode" style="width:140px">
    <label>品項</label><input id="txItem" style="width:160px">
    <label>儲位</label><input id="txLoc" style="width:80px">
  </div>
  <div class="flex" style="margin-top:8px">
    <label>效期</label><input id="txExp" type="date">
    <label>進(+)</label><input id="txIn" type="number" value="0" style="width:90px">
    <label>出(-)</label><input id="txOut" type="number" value="0" style="width:90px">
    <button id="btnSave">新增 / 更新</button>
    <span id="saveMsg"></span>
  </div>
  <div id="log" class="muted"></div>
</fieldset>

<fieldset>
  <legend>線上查詢（Google Sheet）</legend>
  <div class="flex">
    <label>日期自</label><input id="qFrom" type="date">
    <label>日期至</label><input id="qTo" type="date">
    <label>料號含</label><input id="qCodeLike">
    <label>品項含</label><input id="qItemLike">
    <label>儲位含</label><input id="qLocLike">
    <button id="btnQuery" class="secondary">查詢</button>
  </div>
  <div style="overflow:auto;margin-top:8px">
    <table id="tbl">
      <thead><tr>
        <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th><th>效期</th>
        <th>進</th><th>出</th><th>庫存</th><th>寫入時間</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</fieldset>

<fieldset>
  <legend>預警檢查</legend>
  <div class="flex">
    <label>到期天數內</label><input id="warnExp" type="number" value="30" style="width:90px">
    <label>近期平均用量(天)</label><input id="warnLookback" type="number" value="60" style="width:90px">
    <button id="btnWarn" class="secondary">檢查預警</button>
  </div>
  <div id="warnOut"></div>
</fieldset>

<div style="margin-top:16px">
  <a href="shipping.html">➡ 前往出貨管理</a>
</div>

<script>
const $=sel=>document.querySelector(sel);
const api = ()=> localStorage.getItem('apiUrl')||'';
$('#apiUrl').value = api();

function setApi(v){ localStorage.setItem('apiUrl', v); }

$('#btnPing').onclick= async ()=>{
  setApi($('#apiUrl').value.trim());
  try{
    const r = await fetch(api()+'?action=ping');
    $('#log').textContent = await r.text();
  }catch(err){
    $('#log').textContent = '連線失敗：'+err;
  }
};

$('#txBarcode').addEventListener('keydown', async (e)=>{
  if(e.key==='Enter'){
    const bc = $('#txBarcode').value.trim();
    if(!bc||!api()) return;
    const r = await fetch(api()+`?action=productbybarcode&barcode=${encodeURIComponent(bc)}`);
    const j = await r.json();
    if(j && j.product){
      $('#txCode').value = j.product.code||'';
      $('#txItem').value = j.product.item||'';
      $('#txLoc').value  = j.product.default_loc||'';
    }
  }
});

$('#btnSave').onclick = async ()=>{
  if(!api()){ alert('請先設定 API URL'); return; }
  const payload = {
    action:'createTx',
    data:{
      date: $('#txDate').value,
      barcode: $('#txBarcode').value.trim(),
      code: $('#txCode').value.trim(),
      item: $('#txItem').value.trim(),
      loc: $('#txLoc').value.trim(),
      exp: $('#txExp').value,
      in: +($('#txIn').value||0),
      out:+($('#txOut').value||0),
    }
  };
  try{
    const r = await fetch(api(), {method:'POST', body: JSON.stringify(payload)});
    const j = await r.json();
    if(j.ok){
      $('#saveMsg').textContent = '✅ 已寫入。庫存='+ (j.row&&j.row.stock);
      $('#btnQuery').click();
    }else{
      $('#saveMsg').textContent = '❌ 失敗：'+j.error;
    }
  }catch(err){
    $('#saveMsg').textContent = '❌ 發送失敗：'+err;
  }
};

$('#btnQuery').onclick = async ()=>{
  if(!api()){ alert('API 未設定'); return; }
  const url = new URL(api());
  url.searchParams.set('action','query');
  if($('#qFrom').value) url.searchParams.set('dateFrom',$('#qFrom').value);
  if($('#qTo').value)   url.searchParams.set('dateTo',$('#qTo').value);
  if($('#qCodeLike').value) url.searchParams.set('codeLike',$('#qCodeLike').value);
  if($('#qItemLike').value) url.searchParams.set('itemLike',$('#qItemLike').value);
  if($('#qLocLike').value)  url.searchParams.set('locLike',$('#qLocLike').value);
  try{
    const r = await fetch(url.toString());
    const j = await r.json();
    const tb = $('#tbl tbody'); tb.innerHTML='';
    (j.rows||[]).forEach(x=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${x.date||''}</td><td>${x.barcode||''}</td><td>${x.code||''}</td><td>${x.item||''}</td>
      <td>${x.loc||''}</td><td>${x.exp||''}</td><td>${x.in||0}</td><td>${x.out||0}</td><td>${x.stock||0}</td><td>${x.timestamp||''}</td>`;
      tb.appendChild(tr);
    });
  }catch(err){
    alert('查詢失敗：'+err);
  }
};

$('#btnWarn').onclick = async ()=>{
  const expDays = +($('#warnExp').value||30);
  const lbDays = +($('#warnLookback').value||60);
  const url = api()+`?action=alerts&expWithinDays=${expDays}&lookbackDays=${lbDays}`;
  try{
    const r = await fetch(url);
    const j = await r.json();
    const d = j.alerts||{};
    const near = d.nearExp||[], low = d.lowStock||[];
    const out = [];
    out.push(`<h4>到期預警（${near.length}）</h4>`);
    out.push(`<table><thead><tr><th>品項</th><th>料號</th><th>儲位</th><th>效期</th><th>剩餘量</th><th>天數</th></tr></thead><tbody>`);
    near.forEach(x=> out.push(`<tr><td>${x.item}</td><td>${x.code}</td><td>${x.loc}</td><td>${x.exp}</td><td>${x.remain}</td><td>${x.days}</td></tr>`));
    out.push(`</tbody></table>`);
    out.push(`<h4>低庫存預警（${low.length}）</h4>`);
    out.push(`<table><thead><tr><th>品項</th><th>料號</th><th>儲位</th><th>現庫存</th><th>最低庫存</th></tr></thead><tbody>`);
    low.forEach(x=> out.push(`<tr><td>${x.item}</td><td>${x.code}</td><td>${x.loc}</td><td>${x.stock}</td><td>${x.min_stock}</td></tr>`));
    out.push(`</tbody></table>`);
    $('#warnOut').innerHTML = out.join('');
  }catch(err){
    $('#warnOut').innerHTML = '預警查詢失敗：'+err;
  }
};

// default date today
const t = new Date(); const y=t.toISOString().slice(0,10);
$('#txDate').value = y;
$('#qFrom').value = y; $('#qTo').value = y;

</script>
</body>
</html>
