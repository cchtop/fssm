<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>線上倉儲管理</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  body { padding: 14px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .num { text-align:right; }
  table td, table th { vertical-align: middle; }
  .hint { color:#6c757d; font-size: .9rem; }
</style>
</head>
<body>
<h5 class="mb-2">線上倉儲管理</h5>

<div class="mb-3">
  <label class="form-label">API URL（GAS /exec）</label>
  <input id="api" class="form-control mono" placeholder="https://script.google.com/macros/s/XXXXX/exec">
  <div class="d-flex gap-2 mt-2">
    <button id="btnTest" class="btn btn-outline-primary btn-sm">連線測試</button>
    <div class="hint">會儲存在本機瀏覽器（兩頁共用）。</div>
  </div>
</div>

<!-- 掃碼（外部掃描器） -->
<div class="mb-3">
  <div class="d-flex align-items-center gap-2">
    <h6 class="m-0">掃碼新增（條碼/QR）</h6>
    <span class="hint">外部掃描器：TeacApps「Barcode Scanner」。</span>
  </div>
  <div class="input-group mt-2">
    <input id="barcode" class="form-control mono" placeholder="條碼…（可貼上或外部掃描）">
    <button id="btnIntent" class="btn btn-outline-secondary">用外部掃描器（Intent）</button>
  </div>
</div>

<!-- 單筆新增 / 更新 -->
<div class="mb-4">
  <h6>單筆新增 / 更新</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">日期</label>
      <input id="tx_date" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">條碼</label>
      <input id="tx_barcode" class="form-control mono" placeholder="可掃描自動帶入">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">料號</label>
      <input id="tx_code" class="form-control mono">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">品項</label>
      <input id="tx_item" class="form-control">
    </div>

    <div class="col-4 col-md-2">
      <label class="form-label">儲位</label>
      <input id="tx_loc" class="form-control mono">
    </div>
    <div class="col-8 col-md-4">
      <label class="form-label">效期</label>
      <input id="tx_exp" type="date" class="form-control">
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label">進料量(+)</label>
      <input id="tx_in" type="number" class="form-control num" value="0">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">領料量(-)</label>
      <input id="tx_out" type="number" class="form-control num" value="0">
    </div>
  </div>
  <div class="mt-2 d-flex gap-2">
    <button id="btnTx" class="btn btn-primary">新增 / 更新</button>
    <div id="msgTx" class="align-self-center text-danger small"></div>
  </div>
</div>

<!-- 查詢 -->
<div class="mb-4">
  <h6>線上查詢（Google Sheet）</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">日期自</label>
      <input id="q_from" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">日期至</label>
      <input id="q_to" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">料號含</label>
      <input id="q_code" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">品項含</label>
      <input id="q_item" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">儲位含</label>
      <input id="q_loc" class="form-control">
    </div>
  </div>
  <div class="mt-2 d-flex gap-2">
    <button id="btnQuery" class="btn btn-outline-primary">查詢</button>
    <button id="btnSum" class="btn btn-warning">彙總（同日×料號×品項×儲位）</button>
    <a href="shipping.html" class="btn btn-link">前往出貨管理</a>
  </div>
  <div class="table-responsive mt-2">
    <table id="tblQuery" class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th><th>效期</th>
          <th class="num">進</th><th class="num">出</th><th class="num">庫存</th><th>寫入時間</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 預警 -->
<div class="mb-4">
  <h6>預警檢查</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">到期天數內</label>
      <input id="a_exp" type="number" class="form-control" value="30">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">近N日平均用量</label>
      <input id="a_avg" type="number" class="form-control" value="60">
    </div>
  </div>
  <div class="mt-2">
    <button id="btnAlert" class="btn btn-outline-danger">檢查預警</button>
  </div>

  <div class="mt-3">
    <h6 class="mt-3">到期預警</h6>
    <div class="table-responsive">
      <table id="tblExp" class="table table-sm table-striped">
        <thead class="table-light">
          <tr><th>品項</th><th>料號</th><th>儲位</th><th>效期</th><th class="num">剩餘量</th><th class="num">天數</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h6 class="mt-3">低庫存預警</h6>
    <div class="table-responsive">
      <table id="tblLow" class="table table-sm table-striped">
        <thead class="table-light">
          <tr><th>品項</th><th>料號</th><th>儲位</th><th class="num">現庫存</th><th class="num">近N日均用</th><th class="num">最低庫存</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const api = {
  get url(){ return localStorage.getItem('API_URL') || ''; },
  set url(v){ localStorage.setItem('API_URL', v||''); },
  get token(){ return localStorage.getItem('API_TOKEN') || ''; },
  set token(v){ localStorage.setItem('API_TOKEN', v||''); }
};
function setLocalDate(id, d=new Date()){// 轉成「本地日期」字串 YYYY-MM-DD（不受 UTC 影響）
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  $(id).value = z.toISOString().slice(0,10);
}
function num(v){ return Number(v||0); }

async function GET(params){
  const base = $('#api').value.trim();
  if(!base) throw new Error('未設定 API URL');
  params = params || {};
  const token = api.token; if(token) params.token = token;
  const url = base + '?' + new URLSearchParams(params).toString();
  const r = await fetch(url);
  return await r.json();
}
async function POST(body){
  const base = $('#api').value.trim();
  if(!base) throw new Error('未設定 API URL');
  const token = api.token; if(token) body.token = token;
  const r = await fetch(base, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return await r.json();
}

function fillProduct(p){
  if(!p) return;
  $('#tx_code').value = p.code||'';
  $('#tx_item').value = p.item||'';
  $('#tx_loc').value  = (p.default_loc!=null? String(p.default_loc):'') || '';
}
async function tryFillByBarcode(bc){
  if(!bc) return;
  const j = await GET({action:'product', barcode: bc});
  if(j.ok) fillProduct(j.row);
}

function renderRows(tbody, rows){
  tbody.innerHTML='';
  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td class="mono">${r.barcode||''}</td>
      <td class="mono">${r.code||''}</td>
      <td>${r.item||''}</td>
      <td class="mono">${r.loc||''}</td>
      <td>${r.exp||''}</td>
      <td class="num">${num(r.in)}</td>
      <td class="num">${num(r.out)}</td>
      <td class="num">${num(r.stock)}</td>
      <td>${r.timestamp||''}</td>`;
    tbody.appendChild(tr);
  }
}

window.addEventListener('DOMContentLoaded', async ()=>{
  $('#api').value = api.url;
  setToday('#tx_date');
  $('#tx_in').value = 0; $('#tx_out').value = 0;

  // 若 URL ?barcode=... 自動帶入
  const u = new URL(location.href);
  const bc = u.searchParams.get('barcode');
  if(bc){ $('#barcode').value = bc; $('#tx_barcode').value = bc; tryFillByBarcode(bc); }

  // 將掃到的直接同步進單筆區
  $('#barcode').addEventListener('change', (e)=>{
    $('#tx_barcode').value = e.target.value.trim();
    tryFillByBarcode(e.target.value.trim());
  });

  $('#btnTest').addEventListener('click', async ()=>{
    try{
      api.url = $('#api').value.trim();
      const j = await GET({action:'ping'});
      alert(j.ok ? '連線成功！' : ('失敗：'+j.msg));
    }catch(err){ alert('錯誤：'+err.message); }
  });

  $('#btnIntent').addEventListener('click', ()=>{
    // Android 外部掃描器（TeacApps）
    location.href = 'intent:#Intent;action=com.google.zxing.client.android.SCAN;scheme=zxing;package=com.teacapps.barcodescanner;end';
  });

  $('#btnTx').addEventListener('click', async ()=>{
    $('#msgTx').textContent='';
    try{
      const body = {
        action:'tx',
        date: $('#tx_date').value || undefined,
        barcode: $('#tx_barcode').value.trim(),
        code: $('#tx_code').value.trim(),
        item: $('#tx_item').value.trim(),
        loc: $('#tx_loc').value.trim(),
        exp: $('#tx_exp').value,
        qin: num($('#tx_in').value),
        qout: num($('#tx_out').value)
      };
      const j = await POST(body);
      if(!j.ok) throw new Error(j.msg||'新增失敗');
      alert('成功，庫存更新為：'+ j.stock);
    }catch(err){
      $('#msgTx').textContent = '失敗：'+err.message;
    }
  });

  $('#btnQuery').addEventListener('click', async ()=>{
    const j = await GET({
      action:'query',
      date_from: $('#q_from').value,
      date_to: $('#q_to').value,
      code_like: $('#q_code').value.trim(),
      item_like: $('#q_item').value.trim(),
      loc_like: $('#q_loc').value.trim()
    });
    if(!j.ok) return alert(j.msg||'查詢失敗');
    renderRows($('#tblQuery tbody'), j.rows||[]);
  });

  $('#btnSum').addEventListener('click', async ()=>{
    const j = await GET({
      action:'query',
      date_from: $('#q_from').value,
      date_to: $('#q_to').value,
      code_like: $('#q_code').value.trim(),
      item_like: $('#q_item').value.trim(),
      loc_like: $('#q_loc').value.trim()
    });
    if(!j.ok) return alert(j.msg||'查詢失敗');
    renderRows($('#tblQuery tbody'), j.summary||[]);
  });

  $('#btnAlert').addEventListener('click', async ()=>{
    const j = await GET({action:'alerts', expiry_days: $('#a_exp').value, avg_days: $('#a_avg').value});
    if(!j.ok) return alert(j.msg||'查詢失敗');

    // 到期
    const tb1 = $('#tblExp tbody'); tb1.innerHTML='';
    (j.expiry||[]).forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.item||''}</td><td class="mono">${x.code||''}</td><td class="mono">${x.loc||''}</td>
                    <td>${x.exp||''}</td><td class="num">${x.remain||0}</td><td class="num">${x.days||0}</td>`;
      tb1.appendChild(tr);
    });

    // 低庫存
    const tb2 = $('#tblLow tbody'); tb2.innerHTML='';
    (j.low||[]).forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.item||''}</td><td class="mono">${x.code||''}</td><td>${x.loc||''}</td>
                    <td class="num">${x.current||0}</td><td class="num">${x.avg||0}</td><td class="num">${x.min||0}</td>`;
      tb2.appendChild(tr);
    });
  });
});
</script>
</body>
</html>
