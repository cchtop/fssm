<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>線上倉儲管理</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  body{ padding:14px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .num{ text-align:right; }
  .hint{ color:#6c757d; font-size:.9rem; }
</style>
</head>
<body>
<h5>線上倉儲管理</h5>

<div class="mb-3">
  <label class="form-label">API URL（GAS /exec）</label>
  <input id="api" class="form-control mono" placeholder="https://script.google.com/macros/s/XXXXX/exec">
  <div class="d-flex gap-2 mt-2">
    <button id="btnTest" class="btn btn-outline-primary btn-sm">連線測試</button>
    <a class="btn btn-link btn-sm" href="shipping.html">前往出貨管理</a>
  </div>
</div>

<!-- 單筆新增/更新 -->
<div class="mb-3">
  <h6>單筆新增 / 更新</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">日期</label>
      <input id="t_date" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">條碼</label>
      <div class="input-group">
        <input id="t_bar" class="form-control mono" placeholder="可掃描自動帶入">
        <button id="btnIntent" class="btn btn-outline-secondary">用外部掃描器（Intent）</button>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">料號</label>
      <input id="t_code" class="form-control mono">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">品項</label>
      <input id="t_item" class="form-control">
    </div>

    <div class="col-4 col-md-2">
      <label class="form-label">儲位</label>
      <input id="t_loc" class="form-control mono">
    </div>
    <div class="col-4 col-md-2">
      <label class="form-label">效期</label>
      <input id="t_exp" type="date" class="form-control">
    </div>
    <div class="col-4 col-md-2">
      <label class="form-label">進料(+)</label>
      <input id="t_in" type="number" class="form-control num" value="0">
    </div>
    <div class="col-4 col-md-2">
      <label class="form-label">領料(-)</label>
      <input id="t_out" type="number" class="form-control num" value="0">
    </div>
  </div>
  <div class="mt-2">
    <button id="btnSave" class="btn btn-primary">新增 / 更新</button>
    <span class="ms-2 hint">外部掃描器：安裝 **TeaCapps(Barcode Scanner)** 後，點上方按鈕即可。</span>
  </div>
</div>

<!-- 線上查詢 -->
<div class="mb-3">
  <h6>線上查詢（Google Sheet）</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">日期自</label>
      <input id="q_from" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">日期至</label>
      <input id="q_to" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">料號含</label>
      <input id="q_code" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">品項含</label>
      <input id="q_item" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">儲位含</label>
      <input id="q_loc" class="form-control">
    </div>
  </div>
  <div class="mt-2">
    <button id="btnQuery" class="btn btn-outline-primary">查詢</button>
  </div>
  <div class="table-responsive mt-2">
    <table id="tblQ" class="table table-sm table-striped">
      <thead class="table-light">
        <tr><th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
            <th>效期</th><th class="num">進</th><th class="num">出</th><th class="num">庫存</th><th>寫入時間</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 預警 -->
<div class="mb-3">
  <h6>預警檢查</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">到期天數內</label>
      <input id="w_days" type="number" class="form-control" value="30">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">近N日平均用量</label>
      <input id="w_avg" type="number" class="form-control" value="60">
    </div>
  </div>
  <div class="mt-2 d-flex gap-2">
    <button id="btnExp" class="btn btn-outline-warning">檢查到期</button>
    <button id="btnLow" class="btn btn-outline-danger">檢查低庫存</button>
  </div>

  <div class="mt-3">
    <h6>到期預警</h6>
    <div class="table-responsive">
      <table id="tblWX" class="table table-sm table-striped">
        <thead class="table-light">
          <tr><th>品項</th><th>料號</th><th>儲位</th><th>效期</th><th class="num">剩餘量</th><th class="num">天數</th></tr>
        </thead><tbody></tbody>
      </table>
    </div>

    <h6>低庫存預警</h6>
    <div class="table-responsive">
      <table id="tblWL" class="table table-sm table-striped">
        <thead class="table-light"><tr><th>品項</th><th>料號</th><th class="num">現庫存</th><th class="num">最低庫存</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const api = {
  get url(){ return localStorage.getItem('API_URL')||''; },
  set url(v){ localStorage.setItem('API_URL', v||''); },
  get token(){ return localStorage.getItem('API_TOKEN')||''; },
  set token(v){ localStorage.setItem('API_TOKEN', v||''); }
};
function setLocalDate(el, d=new Date()){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  $(el).value = z.toISOString().slice(0,10);
}
function num(v){ return Number(v||0); }

async function GET(params){
  const base = $('#api').value.trim(); if(!base) throw new Error('未設定 API');
  params = params || {};
  const token = api.token; if(token) params.token = token;
  const r = await fetch(base + '?' + new URLSearchParams(params).toString());
  return await r.json();
}
async function POST(body){
  const base = $('#api').value.trim(); if(!base) throw new Error('未設定 API');
  const token = api.token; if(token) body.token = token;
  const r = await fetch(base, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return await r.json();
}

function fillByProduct(p){
  if(!p) return;
  $('#t_code').value = p.code||'';
  $('#t_item').value = p.item||'';
  if(!$('#t_loc').value) $('#t_loc').value = p.default_loc||'';
}

window.addEventListener('DOMContentLoaded', async ()=>{
  $('#api').value = api.url;
  setLocalDate('#t_date'); setLocalDate('#t_exp');
  setLocalDate('#q_from', new Date(Date.now()-7*86400000)); setLocalDate('#q_to');

  // query string ?barcode=...
  const qs = new URL(location.href).searchParams;
  const qb = qs.get('barcode'); if(qb){ $('#t_bar').value = qb; }

  $('#btnTest').addEventListener('click', async ()=>{
    try{ api.url=$('#api').value.trim();
      const j=await GET({action:'ping'}); alert(j.ok?'連線成功！':'失敗');
    }catch(err){ alert('錯誤：'+err.message); }
  });

  $('#btnIntent').addEventListener('click', ()=>{
    location.href='intent:#Intent;action=com.google.zxing.client.android.SCAN;scheme=zxing;package=com.teacapps.barcodescanner;end';
  });

  // 條碼 / 料號輸入後自動帶出產品
  async function probe(key){
    let j = await GET({action:'product', barcode:key});
    if(!j.ok || !j.row){ j = await GET({action:'product', code:key}); }
    fillByProduct(j.row||{});
  }
  $('#t_bar').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); probe(e.target.value.trim()); }});
  $('#t_code').addEventListener('blur', e=>{ const v=e.target.value.trim(); if(v) probe(v); });

  $('#btnSave').addEventListener('click', async ()=>{
    const row = {
      date: $('#t_date').value || undefined,
      barcode: $('#t_bar').value,
      code: $('#t_code').value,
      item: $('#t_item').value,
      loc: $('#t_loc').value,
      exp: $('#t_exp').value,
      in:  num($('#t_in').value),
      out: num($('#t_out').value),
    };
    const j = await POST({action:'tx_create', row});
    if(!j.ok) return alert(j.msg||'寫入失敗');
    alert('已寫入！');
    $('#btnQuery').click();
  });

  $('#btnQuery').addEventListener('click', async ()=>{
    const j=await GET({
      action:'tx_query',
      date_from: $('#q_from').value,
      date_to:   $('#q_to').value,
      code: $('#q_code').value, item: $('#q_item').value, loc: $('#q_loc').value
    });
    const tb = $('#tblQ tbody'); tb.innerHTML='';
    (j.rows||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.date||''}</td><td class="mono">${r.barcode||''}</td><td class="mono">${r.code||''}</td>
                      <td>${r.item||''}</td><td class="mono">${r.loc||''}</td><td>${r.exp||''}</td>
                      <td class="num">${num(r.in)}</td><td class="num">${num(r.out)}</td>
                      <td class="num">${num(r.stock)}</td><td>${r.timestamp||''}</td>`;
      tb.appendChild(tr);
    });
  });

  $('#btnExp').addEventListener('click', async ()=>{
    const j=await GET({action:'warn_expiry', within_days: $('#w_days').value||30});
    const tb=$('#tblWX tbody'); tb.innerHTML='';
    (j.rows||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.item||''}</td><td class="mono">${r.code||''}</td>
                    <td class="mono">${r.loc||''}</td><td>${r.exp||''}</td>
                    <td class="num">${num(r.remain)}</td><td class="num">${r.days}</td>`;
      tb.appendChild(tr);
    });
  });

  $('#btnLow').addEventListener('click', async ()=>{
    const j=await GET({action:'warn_lowstock'});
    const tb=$('#tblWL tbody'); tb.innerHTML='';
    (j.rows||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.item||''}</td><td class="mono">${r.code||''}</td>
                    <td class="num">${num(r.stock)}</td><td class="num">${num(r.min_stock)}</td>`;
      tb.appendChild(tr);
    });
  });

  // 預設先查一次
  $('#btnQuery').click();
});
</script>
</body>
</html>
