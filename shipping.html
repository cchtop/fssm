<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨管理</title>
<style>
body{font-family: system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans TC',sans-serif; margin:16px; line-height:1.5;}
h1{font-size:20px;margin:6px 0 12px}
fieldset{border:1px solid #ddd;border-radius:8px;margin:12px 0;padding:12px}
legend{padding:0 6px;color:#333}
label{display:inline-block;min-width:84px}
input,select,button{font-size:16px;padding:6px 8px;border:1px solid #c7c7c7;border-radius:6px}
button{background:#0d6efd;color:#fff;border:none}
button.secondary{background:#6c757d}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #e5e5e5;padding:6px 8px}
th{background:#f8f8f8}
.flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<h1>出貨管理（連動庫存）</h1>

<fieldset>
  <legend>API URL</legend>
  <div class="flex">
    <input id="apiUrl" style="min-width:320px" placeholder="貼上 Google Apps Script /exec URL">
    <button id="btnPing">連線測試</button>
    <a href="index.html" style="margin-left:auto">回庫存管理</a>
  </div>
</fieldset>

<fieldset>
  <legend>出貨資訊</legend>
  <div class="flex">
    <label>出貨日期</label><input id="shipDate" type="date">
    <label>廠商</label><select id="vendor"></select>
    <label>聯絡</label><input id="contact" style="width:140px">
    <label>電話</label><input id="phone" style="width:160px">
    <label>地址</label><input id="address" style="width:260px">
  </div>
  <div class="flex" style="margin-top:8px">
    <label>備註</label><input id="note" style="width:420px">
  </div>
</fieldset>

<fieldset>
  <legend>新增出貨品項（可用外部掃描器填入條碼後 Enter）</legend>
  <div class="flex">
    <label>條碼</label><input id="bc" placeholder="掃描或輸入條碼">
    <label>料號</label><input id="code" style="width:140px">
    <label>品項</label><input id="item" style="width:180px">
    <label>規格</label><input id="spec" style="width:140px">
    <label>儲位</label><input id="loc" style="width:80px">
    <label>效期</label><input id="exp" type="date">
    <label>數量</label><input id="qty" type="number" value="1" style="width:90px">
    <label>單價</label><input id="price" type="number" value="0" style="width:90px" step="0.01">
    <button id="addLine">加入清單</button>
  </div>
  <small>提示：先掃條碼→自動帶出料號/品項/儲位，必要欄位不足也可直接加入（僅憑料號/數量出貨）。</small>
</fieldset>

<div style="overflow:auto">
  <table id="lines">
    <thead><tr><th>#</th><th>條碼</th><th>料號</th><th>品項</th><th>規格</th><th>儲位</th><th>效期</th><th>數量</th><th>單價</th><th>金額</th><th></th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th colspan="9" style="text-align:right">合計</th><th id="sum">0</th><th></th></tr></tfoot>
  </table>
</div>

<div class="flex" style="margin-top:8px">
  <button id="btnSubmit">建立出貨單並扣庫存</button>
  <div id="result"></div>
</div>

<script>
const $=sel=>document.querySelector(sel);
const api=()=>localStorage.getItem('apiUrl')||'';
$('#apiUrl').value=api();
function setApi(v){ localStorage.setItem('apiUrl',v); }
const state={lines:[]};

function refreshVendors(){
  if(!api()) return;
  fetch(api()+'?action=listvendors').then(r=>r.json()).then(j=>{
    const sel=$('#vendor'); sel.innerHTML='';
    const empty = document.createElement('option'); empty.value=''; empty.textContent='-- 請選擇 --'; sel.appendChild(empty);
    (j.vendors||[]).forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name; opt.textContent=v.name;
      opt.dataset.contact=v.contact||''; opt.dataset.phone=v.phone||''; opt.dataset.address=v.address||'';
      sel.appendChild(opt);
    });
  });
}
$('#vendor').onchange=()=>{
  const o=$('#vendor').selectedOptions[0];
  if(!o) return; $('#contact').value=o.dataset.contact||''; $('#phone').value=o.dataset.phone||''; $('#address').value=o.dataset.address||'';
};

$('#btnPing').onclick=async ()=>{
  setApi($('#apiUrl').value.trim());
  try{ const r=await fetch(api()+'?action=ping'); $('#result').textContent=await r.text(); }
  catch(e){ $('#result').textContent='連線失敗：'+e; }
};

$('#bc').addEventListener('keydown', async (e)=>{
  if(e.key==='Enter' && $('#bc').value.trim()){
    try{
      const r = await fetch(api()+`?action=productbybarcode&barcode=${encodeURIComponent($('#bc').value.trim())}`);
      const j = await r.json();
      if(j.product){
        $('#code').value=j.product.code||'';
        $('#item').value=j.product.item||'';
        $('#spec').value=j.product.spec||'';
        $('#loc').value=j.product.default_loc||'';
      }
      $('#qty').focus();
    }catch(err){}
  }
});

function render(){
  const tb=$('#lines tbody'); tb.innerHTML='';
  let s=0;
  state.lines.forEach((ln,i)=>{
    const tr=document.createElement('tr');
    const amt=(+ln.qty||0)*(+ln.unit_price||0); s+=amt;
    tr.innerHTML=`<td>${i+1}</td><td>${ln.barcode||''}</td><td>${ln.code||''}</td><td>${ln.item||''}</td>
    <td>${ln.spec||''}</td><td>${ln.loc||''}</td><td>${ln.exp||''}</td><td>${ln.qty||0}</td><td>${ln.unit_price||0}</td><td>${amt.toFixed(2)}</td>
    <td><button data-i="${i}" class="secondary">刪除</button></td>`;
    tb.appendChild(tr);
  });
  $('#sum').textContent=s.toFixed(2);
  tb.querySelectorAll('button').forEach(b=> b.onclick=()=>{ state.lines.splice(+b.dataset.i,1); render(); });
}

$('#addLine').onclick=()=>{
  const ln={
    barcode: $('#bc').value.trim(), code: $('#code').value.trim(), item: $('#item').value.trim(), spec: $('#spec').value.trim(),
    loc: $('#loc').value.trim(), exp: $('#exp').value, qty: +($('#qty').value||0), unit_price: +($('#price').value||0)
  };
  if(!(ln.code||ln.barcode) || ln.qty<=0){ alert('請至少輸入「料號或條碼」及「數量」'); return; }
  state.lines.push(ln);
  ['bc','code','item','spec','loc','exp','qty','price'].forEach(id=> $('#'+id).value = id==='qty'?1:'');
  render();
};

$('#btnSubmit').onclick=async ()=>{
  if(!api()){ alert('請先設定 API URL'); return; }
  if(!state.lines.length){ alert('請加入至少一個品項'); return; }
  const header={
    date: $('#shipDate').value,
    vendor: $('#vendor').value, contact: $('#contact').value, phone: $('#phone').value, address: $('#address').value,
    note: $('#note').value
  };
  try{
    const r = await fetch(api(), {method:'POST', body: JSON.stringify({action:'createShipment', header, lines: state.lines})});
    const j = await r.json();
    if(j.ok){
      const sid = j.ship_id;
      $('#result').innerHTML = `✅ 已建立出貨單：<b>${sid}</b>　金額合計 ${j.total.toFixed(2)}　
      <a target="_blank" href="shipment_print.html?ship_id=${encodeURIComponent(sid)}&api=${encodeURIComponent(api())}">列印</a>`;
      state.lines = []; render();
    }else{
      $('#result').textContent = '❌ 失敗：'+j.error;
    }
  }catch(err){
    $('#result').textContent = '❌ 發送失敗：'+err;
  }
};

const t=new Date(); $('#shipDate').value=t.toISOString().slice(0,10);
refreshVendors();
</script>
</body>
</html>
