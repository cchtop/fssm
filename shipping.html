<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨管理//張欽宏設計開發（連動庫存）</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<style>
  body{padding:16px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small-note{font-size:.9rem;color:#666}
</style>
</head>
<body>
<h4 class="mb-3">出貨管理//張欽宏設計開發（連動庫存）</h4>

<div class="mb-3">
  <label class="form-label">API URL（GAS /exec）</label>
  <input id="api" class="form-control" placeholder="https://script.google.com/macros/s/xxxxx/exec">
  <div class="mt-2">
    <button class="btn btn-outline-primary btn-sm" id="btnTest">連線測試</button>
    <span id="ping" class="ms-2 small-note"></span>
  </div>
</div>

<!-- 出貨表頭 -->
<div class="card mb-3">
  <div class="card-header">出貨資訊</div>
  <div class="card-body row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">出貨日期</label>
      <input id="sDate" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">廠商</label>
      <div class="input-group">
        <select id="sVendor" class="form-select"></select>
        <button class="btn btn-outline-secondary" id="btnVendNew">新增</button>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">聯絡人</label>
      <input id="sContact" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">電話</label>
      <input id="sPhone" class="form-control">
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">地址</label>
      <input id="sAddr" class="form-control">
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">備註</label>
      <input id="sNote" class="form-control">
    </div>
  </div>
</div>

<!-- 明細新增 -->
<div class="card mb-3">
  <div class="card-header">新增出貨品項（可用外部掃描器後輸入條碼按 Enter）</div>
  <div class="card-body row g-2">
    <div class="col-12">
      <div class="input-group">
        <input id="kw" class="form-control mono" placeholder="條碼 / 料號 / 品名關鍵字；輸入後按 Enter">
        <button class="btn btn-outline-secondary" id="btnExt">用外部掃描器</button>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">儲位</label>
      <input id="sLoc" class="form-control mono" placeholder="default">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">效期</label>
      <input id="sExp" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">數量</label>
      <input id="sQty" type="number" value="1" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">單價</label>
      <input id="sPrice" type="number" value="0" class="form-control">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label d-block">&nbsp;</label>
      <button class="btn btn-primary w-100" id="btnAdd">加入清單</button>
    </div>

    <div class="col-12 mt-3">
      <div class="table-responsive">
        <table class="table table-sm table-striped" id="list">
          <thead class="table-light"><tr>
            <th>#</th><th>條碼</th><th>料號</th><th>品項</th><th>規格</th><th>儲位</th><th>效期</th><th>數量</th><th>單價</th><th>金額</th><th></th>
          </tr></thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="9" class="text-end">合計</td><td id="sum" class="text-end">0</td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" id="btnCreate">建立出貨單並扣庫存</button>
      <span id="sMsg" class="ms-2 small-note"></span>
    </div>
  </div>
</div>

<!-- 最近出貨 -->
<div class="card">
  <div class="card-header">最近出貨</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm" id="recent">
        <thead class="table-light"><tr><th>出貨單號</th><th>日期</th><th>客戶</th><th>金額</th><th>PDF</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
function localYMD(d){           // 本地 yyyy-MM-dd
  const t = new Date(d || Date.now());
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,10);
}
function localISO(d){           // 本地 ISO（yyyy-MM-ddTHH:mm:ss）
  const t = new Date(d || Date.now());
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,19);
}
const $ = s => document.querySelector(s);
const apiInput = $('#api');
const saveAPI = ()=> localStorage.setItem('fms_api', apiInput.value.trim());
const loadAPI = ()=> apiInput.value = localStorage.getItem('fms_api') || '';
loadAPI();
$('#sDate').value = localYMD();

$('#btnTest').onclick = async()=>{
  saveAPI();
  const r = await fetch(apiInput.value+'?mode=ready').then(r=>r.json()).catch(()=>null);
  $('#ping').textContent = r?.ok ? '連線成功' : '失敗';
};

async function loadVendors(){
  if(!apiInput.value) return;
  const r = await fetch(apiInput.value+'?mode=vendors').then(r=>r.json()).catch(()=>null);
  const sel = $('#sVendor'); sel.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.text='(選擇/可空白)'; sel.appendChild(opt0);
  (r?.vendors||[]).forEach(v=>{
    const o = document.createElement('option');
    o.value = v.name; o.text = v.name;
    o.dataset.contact = v.contact||''; o.dataset.phone = v.phone||''; o.dataset.addr = v.addr||'';
    sel.appendChild(o);
  });
}
loadVendors();

$('#sVendor').onchange = ()=>{
  const o = $('#sVendor').selectedOptions[0];
  if(!o) return;
  $('#sContact').value = o.dataset.contact||'';
  $('#sPhone').value = o.dataset.phone||'';
  $('#sAddr').value = o.dataset.addr||'';
};
$('#btnVendNew').onclick = async()=>{
  const name = prompt('廠商名稱？'); if(!name) return;
  const contact = prompt('聯絡人？')||''; const phone = prompt('電話？')||''; const addr = prompt('地址？')||'';
  const body = { mode:'vendor_upsert', vendor:{ name, contact, phone, addr } };
  const r = await fetch(apiInput.value, {method:'POST', body:JSON.stringify(body)}).then(r=>r.json()).catch(()=>null);
  if(r?.ok){ await loadVendors(); $('#sVendor').value=name; $('#sVendor').dispatchEvent(new Event('change')); }
};

// 外部掃碼 Intent
$('#btnExt').onclick = ()=>{
  const ret = location.origin + location.pathname + '?barcode={CODE}';
  location.href = 'zxing://scan/?ret=' + encodeURIComponent(ret);
};
// 若網址回來帶 barcode，自動帶入 kw
const bc = new URLSearchParams(location.search).get('barcode');
if (bc) $('#kw').value = bc;

const list = [];
function renderList(){
  const tb = $('#list tbody'); tb.innerHTML = '';
  let sum=0;
  list.forEach((x,i)=>{
    const tr = document.createElement('tr');
    const amt = Number(x.unit_price||0)*Number(x.qty_out||0);
    sum += amt;
    tr.innerHTML = `<td>${i+1}</td>
      <td class="mono">${x.barcode||''}</td><td class="mono">${x.code||''}</td>
      <td>${x.item||''}</td><td>${x.spec||''}</td>
      <td class="mono">${x.loc||''}</td><td>${x.exp||''}</td>
      <td class="text-end">${x.qty_out||0}</td>
      <td class="text-end">${x.unit_price||0}</td>
      <td class="text-end">${amt}</td>
      <td><button class="btn btn-sm btn-outline-danger" data-i="${i}">刪除</button></td>`;
    tb.appendChild(tr);
  });
  $('#sum').textContent = sum.toFixed(2);
  tb.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.onclick = ()=>{ list.splice(Number(btn.dataset.i),1); renderList(); };
  });
}

async function lookupProduct(keyword){
  // 支援 barcode 或 code
  let url = apiInput.value+'?mode=product';
  if (/^\d{6,}$/.test(keyword)) url += '&barcode='+encodeURIComponent(keyword);
  else url += '&code='+encodeURIComponent(keyword);
  const r = await fetch(url).then(r=>r.json()).catch(()=>null);
  return r?.ok ? r.product : null;
}

$('#kw').addEventListener('keydown', async(e)=>{
  if (e.key==='Enter') {
    $('#btnAdd').click();
  }
});

$('#btnAdd').onclick = async()=>{
  saveAPI();
  const kw = $('#kw').value.trim();
  if(!kw){ alert('請輸入條碼/料號/關鍵字'); return; }
  const p = await lookupProduct(kw);
  if(!p){ alert('找不到產品'); return; }

  const line = {
    barcode: p.barcode || kw,
    code: p.code || kw,
    item: p.item || '',
    spec: p.spec || '',
    loc: $('#sLoc').value || p.default_loc || '',
    exp: $('#sExp').value || '',
    qty_out: Number($('#sQty').value||0),
    unit_price: Number($('#sPrice').value||0)
  };
  list.push(line);
  renderList();
  // 清空輸入
  $('#kw').value=''; $('#sQty').value=1; $('#sPrice').value=0;
};

$('#btnCreate').onclick = async()=>{
  saveAPI();
  if (!list.length){ alert('明細為空'); return; }
  const header = {
    date: $('#sDate').value,
    vendor: $('#sVendor').value,
    contact: $('#sContact').value,
    phone: $('#sPhone').value,
    addr: $('#sAddr').value,
    note: $('#sNote').value
  };
  $('#sMsg').textContent = '處理中…';
  const r = await fetch(apiInput.value, {method:'POST', body:JSON.stringify({mode:'ship', header, lines:list})})
                  .then(r=>r.json()).catch(e=>({ok:false,msg:String(e)}));
  if (r.ok) {
    $('#sMsg').textContent = `完成，出貨單號：${r.ship_id}`;
    // 開啟列印頁
    const url = `shipment_print.html?ship_id=${encodeURIComponent(r.ship_id)}&api=${encodeURIComponent(apiInput.value)}`;
    window.open(url, '_blank');
    // 重新載入最近出貨
    loadRecent();
    // 清空當前清單
    list.length = 0; renderList();
  } else {
    $('#sMsg').textContent = '失敗：'+(r.msg||'');
  }
};

async function loadRecent(){
  if(!apiInput.value) return;
  const r = await fetch(apiInput.value+'?mode=ship_list&limit=20').then(r=>r.json()).catch(()=>null);
  const tb = $('#recent tbody'); tb.innerHTML='';
  (r?.rows||[]).forEach(h=>{
    const tr = document.createElement('tr');
    const link = `shipment_print.html?ship_id=${encodeURIComponent(h.ship_id)}&api=${encodeURIComponent(apiInput.value)}`;
    tr.innerHTML = `<td class="mono">${h.ship_id}</td><td>${localYMD(h.date)||''}</td><td>${h.vendor||''}</td>
      <td class="text-end">${Number(h.amount||0).toFixed(2)}</td>
      <td><a href="${link}" target="_blank">列印</a></td>`;
    tb.appendChild(tr);
  });
}
loadRecent();
</script>
</body>
</html>
