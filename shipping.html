<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨管理（連動庫存）</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  body { padding: 14px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .num{ text-align:right; }
  table td, table th { vertical-align: middle; }
  .hint{ color:#6c757d; font-size:.9rem; }
</style>
</head>
<body>
<h5>出貨管理（連動庫存）</h5>

<div class="mb-3">
  <label class="form-label">API URL（GAS /exec）</label>
  <input id="api" class="form-control mono" placeholder="https://script.google.com/macros/s/XXXXX/exec">
  <div class="d-flex gap-2 mt-2">
    <button id="btnTest" class="btn btn-outline-primary btn-sm">連線測試</button>
    <div class="hint">與倉儲頁共用 URL / Token 。</div>
  </div>
</div>

<!-- Header -->
<div class="mb-3">
  <h6>出貨資訊</h6>
  <div class="row g-2">
    <div class="col-6 col-md-3">
      <label class="form-label">出貨日期</label>
      <input id="ship_date" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">廠商</label>
      <div class="input-group">
        <select id="vendor" class="form-select"></select>
        <button id="btnNewVendor" class="btn btn-outline-secondary">新增</button>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">聯絡人</label>
      <input id="contact" class="form-control">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">電話</label>
      <input id="phone" class="form-control">
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">地址</label>
      <input id="address" class="form-control">
    </div>
    <div class="col-12 col-md-6">
      <label class="form-label">備註</label>
      <input id="memo" class="form-control">
    </div>
  </div>
</div>

<!-- Lines -->
<div class="mb-3">
  <h6>新增出貨品項（可用外部掃描器或輸入條碼後按 Enter）</h6>
  <div class="row g-2">
    <div class="col-12 col-md-4">
      <label class="form-label">條碼 / 料號 / 品名關鍵字</label>
      <div class="input-group">
        <input id="scan" class="form-control mono" placeholder="輸入後按 Enter 或用外部掃描器">
        <button id="btnIntent" class="btn btn-outline-secondary">用外部掃描器</button>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">儲位</label>
      <input id="l_loc" class="form-control mono" value="default">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">效期</label>
      <input id="l_exp" type="date" class="form-control">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">數量</label>
      <input id="l_qty" type="number" class="form-control num" value="1">
    </div>
    <div class="col-6 col-md-1">
      <label class="form-label">單價</label>
      <input id="l_price" type="number" class="form-control num" value="0">
    </div>
  </div>
  <div class="mt-2">
    <button id="btnAdd" class="btn btn-primary">加入清單</button>
  </div>

  <div class="table-responsive mt-2">
    <table id="tbl" class="table table-sm table-striped">
      <thead class="table-light">
        <tr>
          <th>#</th><th>條碼</th><th>料號</th><th>品項</th><th>規格</th>
          <th>儲位</th><th>效期</th><th class="num">數量</th><th class="num">單價</th><th class="num">金額</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="9" class="text-end">合計</td><td id="sumAmt" class="num">0</td><td></td></tr></tfoot>
    </table>
  </div>

  <div class="d-flex gap-2">
    <button id="btnSaveShip" class="btn btn-success">建立出貨單並扣庫存</button>
    <a class="btn btn-link" href="index.html">回倉儲管理</a>
  </div>
</div>

<!-- 最近出貨 -->
<div class="mb-3">
  <h6>最近出貨</h6>
  <div class="table-responsive">
    <table id="tblRecent" class="table table-sm table-striped">
      <thead class="table-light">
        <tr><th>出貨單號</th><th>日期</th><th>客戶</th><th class="num">金額</th><th>PDF</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const $=sel=>document.querySelector(sel);
const api = {
  get url(){ return localStorage.getItem('API_URL') || ''; },
  set url(v){ localStorage.setItem('API_URL', v||''); },
  get token(){ return localStorage.getItem('API_TOKEN') || ''; },
  set token(v){ localStorage.setItem('API_TOKEN', v||''); }
};
function setLocalDate(id, d=new Date()){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  $(id).value = z.toISOString().slice(0,10);
}
function num(v){ return Number(v||0); }
let LINES = [];

async function GET(params){
  const base = $('#api').value.trim(); if(!base) throw new Error('未設定 API');
  params = params || {};
  const token = api.token; if(token) params.token = token;
  const url = base + '?' + new URLSearchParams(params).toString();
  const r = await fetch(url); return await r.json();
}
async function POST(body){
  const base = $('#api').value.trim(); if(!base) throw new Error('未設定 API');
  const token = api.token; if(token) body.token = token;
  const r = await fetch(base, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return await r.json();
}

function sumAmount(){ return LINES.reduce((s,x)=> s + num(x.qty_out)*num(x.unit_price), 0); }
function renderLines(){
  const tb = $('#tbl tbody'); tb.innerHTML='';
  LINES.forEach((l,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td class="mono">${l.barcode||''}</td>
      <td class="mono">${l.code||''}</td>
      <td>${l.item||''}</td>
      <td>${l.spec||''}</td>
      <td class="mono">${l.loc||''}</td>
      <td>${l.exp||''}</td>
      <td class="num">${num(l.qty_out)}</td>
      <td class="num">${num(l.unit_price)}</td>
      <td class="num">${num(l.qty_out)*num(l.unit_price)}</td>
      <td><button class="btn btn-sm btn-outline-danger" data-i="${i}">刪</button></td>
    `;
    tb.appendChild(tr);
  });
  $('#sumAmt').textContent = sumAmount();
  tb.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const i = Number(e.currentTarget.dataset.i);
      LINES.splice(i,1); renderLines();
    });
  });
}
async function fillVendorFields(){
  // 依下拉帶出 vendor info（若有）
  const name = $('#vendor').value;
  if(!name) return;
  const j = await GET({action:'vendors'});
  if(!j.ok) return;
  const v = (j.rows||[]).find(x=> (x.name||'')===name );
  if(v){
    $('#contact').value = v.contact||'';
    $('#phone').value = v.phone||'';
    $('#address').value = v.address||'';
  }
}

window.addEventListener('DOMContentLoaded', async ()=>{
  $('#api').value = api.url;
  setLocalDate('#ship_date');
  setLocalDate('#l_exp');

  // vendors
  const jv = await GET({action:'vendors'});
  const sel = $('#vendor'); sel.innerHTML='';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='（選擇／可空白）';
  sel.appendChild(opt0);
  (jv.rows||[]).forEach(v=>{
    const op=document.createElement('option'); op.value=v.name; op.textContent=v.name;
    sel.appendChild(op);
  });
  sel.addEventListener('change', fillVendorFields);

  $('#btnTest').addEventListener('click', async ()=>{
    try{
      api.url = $('#api').value.trim();
      const j = await GET({action:'ping'});
      alert(j.ok?'連線成功！':('失敗：'+j.msg));
    }catch(err){ alert('錯誤：'+err.message); }
  });

  $('#btnNewVendor').addEventListener('click', async ()=>{
    const name = prompt('輸入新廠商名稱：'); if(!name) return;
    const v = {name, contact:$('#contact').value, phone:$('#phone').value, address:$('#address').value, memo:$('#memo').value};
    const j = await POST({action:'vendor_save', row:v});
    if(!j.ok) return alert(j.msg||'新增失敗');
    const op = document.createElement('option'); op.value=name; op.textContent=name; $('#vendor').appendChild(op);
    $('#vendor').value = name;
  });

  $('#btnIntent').addEventListener('click', ()=>{
    location.href = 'intent:#Intent;action=com.google.zxing.client.android.SCAN;scheme=zxing;package=com.teacapps.barcodescanner;end';
  });

  async function pushByScanKey(s){
    if(!s) return;
    // 以條碼為主查產品
    let prod = await GET({action:'product', barcode:s});
    if(!prod.ok || !prod.row){
      // 條碼找不到，再以 code 試試
      prod = await GET({action:'product', code:s});
    }
    const p = prod.row||{};
    const line = {
      barcode: p.barcode||'',
      code: p.code||s,
      item: p.item||'',
      spec: p.spec||'',
      loc: $('#l_loc').value.trim(),
      exp: $('#l_exp').value,
      qty_out: num($('#l_qty').value),
      unit_price: num($('#l_price').value)
    };
    if(!line.exp) { alert('請先選擇效期'); return; }
    if(!line.loc) line.loc = 'default';
    LINES.push(line); renderLines();
    $('#scan').value='';
  }
  $('#scan').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); pushByScanKey(e.currentTarget.value.trim()); }
  });
  $('#btnAdd').addEventListener('click', ()=> pushByScanKey($('#scan').value.trim()));

  $('#btnSaveShip').addEventListener('click', async ()=>{
    if(!LINES.length) return alert('尚未加入任何品項');
    const body = {
      action:'shipment',
      ship_date: $('#ship_date').value || undefined,
      vendor: $('#vendor').value, contact: $('#contact').value, phone: $('#phone').value,
      address: $('#address').value, memo: $('#memo').value,
      lines: LINES
    };
    const j = await POST(body);
    if(!j.ok) return alert(j.msg||'建立失敗');
    // 清空 & 重新載入最近
    LINES = []; renderLines();
    alert('已建立出貨單：'+ j.ship_id);
    // 開列印頁
    window.open('shipment_print.html?ship_id='+ encodeURIComponent(j.ship_id), '_blank');
    loadRecent();
  });

  async function loadRecent(){
    const jr = await GET({action:'ship_recent'});
    const tb = $('#tblRecent tbody'); tb.innerHTML='';
    (jr.rows||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="mono">${r.ship_id}</td><td>${r.ship_date||''}</td><td>${r.vendor||''}</td>
                    <td class="num">${Number(r.amount||0)}</td>
                    <td><a target="_blank" href="shipment_print.html?ship_id=${encodeURIComponent(r.ship_id)}">列印</a></td>`;
      tb.appendChild(tr);
    });
  }
  loadRecent();
});
</script>
</body>
</html>
