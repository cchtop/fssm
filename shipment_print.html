<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨單列印</title>
<style>
body{font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:24px;}
h1{font-size:20px;margin:0 0 8px}
table{border-collapse:collapse;width:100%;margin-top:12px}
th,td{border:1px solid #333;padding:6px 8px;font-size:14px}
th{background:#f2f2f2}
.header{display:flex;justify-content:space-between;align-items:flex-start}
.small{font-size:12px;color:#333}
.print{margin:12px 0}
@media print {
  .noprint{display:none}
  body{margin:8px}
}
</style>
</head>
<body>
<div class="noprint print">
  <button onclick="window.print()">列印</button>
  <a style="margin-left:8px" href="shipping.html">返回出貨管理</a>
</div>
<div id="root">讀取中…</div>

<script>
function qs(key){ return new URL(location.href).searchParams.get(key); }
const api = qs('api'); const ship_id = qs('ship_id');

async function main(){
  if(!api || !ship_id){
    document.getElementById('root').textContent = '缺少 ship_id 或 API URL';
    return;
  }
  try{
    const r = await fetch(api+`?action=shipment&ship_id=${encodeURIComponent(ship_id)}`);
    const j = await r.json();
    if(!j.ok || !j.data){ throw new Error('找不到出貨單'); }
    const d = j.data;
    const h = d.header; const lines = d.lines||[];
    const sum = d.total||0;
    const html = [];
    html.push(`<div class="header"><div>
      <h1>出貨單</h1>
      <div class="small">出貨單號：${d.ship_id}</div>
      <div class="small">出貨日期：${h.date||''}</div>
    </div>
    <div class="small">
      <div>廠商：${h.vendor||''}</div>
      <div>聯絡：${h.contact||''}　電話：${h.phone||''}</div>
      <div>地址：${h.address||''}</div>
    </div></div>`);
    html.push(`<table><thead><tr><th>#</th><th>條碼</th><th>料號</th><th>品項</th><th>規格</th><th>儲位</th><th>效期</th><th>數量</th><th>單價</th><th>金額</th></tr></thead><tbody>`);
    lines.forEach((x,i)=>{
      html.push(`<tr><td>${i+1}</td><td>${x.barcode||''}</td><td>${x.code||''}</td><td>${x.item||''}</td><td>${x.spec||''}</td><td>${x.loc||''}</td><td>${x.exp||''}</td><td>${x.qty_out||x.qty||0}</td><td>${x.unit_price||0}</td><td>${x.amount||((x.qty_out||x.qty||0)*(x.unit_price||0))}</td></tr>`)
    });
    html.push(`</tbody><tfoot><tr><th colspan="9" style="text-align:right">合計</th><th>${(+sum).toFixed(2)}</th></tr></tfoot></table>`);
    html.push(`<div style="margin-top:8px" class="small">備註：${h.note||''}</div>`);
    document.getElementById('root').innerHTML = html.join('');
    setTimeout(()=>{ try{ window.print(); }catch(e){} }, 200);
  }catch(err){
    document.getElementById('root').textContent = '讀取失敗：'+err;
  }
}
main();
</script>
</body>
</html>

