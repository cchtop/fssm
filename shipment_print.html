<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨單</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<style>
  body{padding:16px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .text-end{ text-align: right; }
  @media print { .no-print{ display:none } }
</style>
</head>
<body>
<div id="err" class="text-danger"></div>
<div class="no-print mb-3">
  <button class="btn btn-primary" onclick="window.print()">列印</button>
  <a class="btn btn-link" href="shipping.html">回出貨管理</a>
</div>

<div id="doc" class="container"></div>

<script>
// -------- 本地時間工具（避免少一天） --------
function localYMD(d){
  if (!d) return '';
  if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(d.trim())) return d.trim();
  const t = new Date(d);
  if (isNaN(t)) return '';
  t.setMinutes(t.getMinutes() - t.getTimezoneOffset());
  return t.toISOString().slice(0,10);
}

const qs = new URLSearchParams(location.search);
const ship_id = qs.get('ship_id');
const api = qs.get('api');

if(!ship_id || !api){
  document.getElementById('err').textContent = '缺少 ship_id 或 API URL';
} else {
  loadDoc();
}

async function loadDoc(){
  const url = new URL(api);
  url.searchParams.set('mode','ship_doc');
  url.searchParams.set('ship_id', ship_id);
  const r = await fetch(url).then(r=>r.json()).catch(()=>null);
  if(!r?.ok){ document.getElementById('err').textContent='讀取失敗'; return; }
  render(r.header, r.lines);
}

function render(H, L){
  const el = document.getElementById('doc');
  const sum = (L||[]).reduce((s,x)=> s + Number(x.amount||0), 0);

  el.innerHTML = `
    <div class="row align-items-center">
      <div class="col-8"><h4 class="mb-0">出貨單</h4></div>
      <div class="col-4 text-end">
        <svg id="bc" class="mono"></svg>
        <div class="mono">${H.ship_id}</div>
      </div>
    </div>

    <table class="table table-bordered table-sm mt-3">
      <tbody>
        <tr>
          <th style="width:100px">出貨日期</th><td style="width:220px">${localYMD(H.date)||''}</td>
          <th style="width:100px">客戶</th><td>${H.vendor||''}</td>
        </tr>
        <tr><th>聯絡人</th><td>${H.contact||''}</td><th>電話</th><td>${H.phone||''}</td></tr>
        <tr><th>地址</th><td colspan="3">${H.addr||''}</td></tr>
        <tr><th>備註</th><td colspan="3">${H.note||''}</td></tr>
      </tbody>
    </table>

    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead class="table-light"><tr>
          <th class="text-center" style="width:60px">項次</th>
          <th>條碼</th><th>料號</th><th>品項</th><th>規格</th><th>儲位</th><th>效期</th>
          <th class="text-end" style="width:100px">數量</th>
          <th class="text-end" style="width:100px">單價</th>
          <th class="text-end" style="width:120px">金額</th>
        </tr></thead>
        <tbody>
          ${(L||[]).map((x,i)=>`
            <tr>
              <td class="text-center">${i+1}</td>
              <td class="mono">${x.barcode||''}</td>
              <td class="mono">${x.code||''}</td>
              <td>${x.item||''}</td>
              <td>${x.spec||''}</td>
              <td class="mono">${x.loc||''}</td>
              <td>${(localYMD(x.exp)||'').toString().slice(0,10)}</td>
              <td class="text-end">${Number(x.qty_out||0)}</td>
              <td class="text-end">${Number(x.unit_price||0).toFixed(2)}</td>
              <td class="text-end">${Number(x.amount||0).toFixed(2)}</td>
            </tr>`).join('')}
        </tbody>
        <tfoot><tr><td colspan="9" class="text-end">合計</td><td class="text-end">${sum.toFixed(2)}</td></tr></tfoot>
      </table>
    </div>`;
  try { JsBarcode("#bc", H.ship_id, {format:"CODE128", height:40}); } catch(e){}
}
</script>
</body>
</html>
