<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>出貨單</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<style>
  :root{ --fs: 12px; }
  @media print {
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
  body{ padding:16px; font-size:var(--fs); }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .num{ text-align:right; }
  .doc { max-width: 900px; margin:auto; }
  .head-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .title { font-size:18px; font-weight:700; }
  .barcode-box{ text-align:right; }
  table { table-layout: fixed; width:100%; }
  thead th{ text-align:center; }
  td, th { padding:6px 8px; border:1px solid #ccc; }
  .no-border td{ border:none!important; }
  .w-idx{ width:40px; }
  .w-code{ width:130px; } .w-bar{ width:150px; } .w-loc{ width:60px; }
  .w-exp{ width:100px; } .w-qty{ width:70px; } .w-price{ width:80px; } .w-amt{ width:90px; }
  .note{ color:#6c757d; }
</style>
</head>
<body>
<div class="doc">
  <div class="mb-2">
    <button class="btn btn-primary btn-sm" onclick="window.print()">列印</button>
    <a id="back" class="btn btn-link btn-sm" href="shipping.html">回出貨管理</a>
  </div>

  <div class="head-bar">
    <div class="title">出貨單</div>
    <div class="barcode-box">
      <svg id="bc"></svg>
      <div id="ship_id" class="mono small text-end"></div>
    </div>
  </div>

  <table class="mb-2">
    <tbody>
      <tr>
        <td style="width:12%">出貨日期</td><td id="d_date" style="width:38%"></td>
        <td style="width:12%">客戶</td><td id="d_vendor" style="width:38%"></td>
      </tr>
      <tr>
        <td>聯絡人</td><td id="d_contact"></td>
        <td>電話</td><td id="d_phone"></td>
      </tr>
      <tr>
        <td>地址</td><td id="d_addr"></td>
        <td>備註</td><td id="d_memo"></td>
      </tr>
    </tbody>
  </table>

  <table>
    <thead class="table-light">
      <tr>
        <th class="w-idx">項次</th>
        <th class="w-bar">條碼</th>
        <th class="w-code">料號</th>
        <th>品項</th>
        <th>規格</th>
        <th class="w-loc">儲位</th>
        <th class="w-exp">效期</th>
        <th class="w-qty">數量</th>
        <th class="w-price">單價</th>
        <th class="w-amt">金額</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
    <tfoot>
      <tr>
        <td colspan="9" class="num">合計</td>
        <td id="t_sum" class="num mono"></td>
      </tr>
    </tfoot>
  </table>

  <div class="note mt-2">* 本單右上角條碼為出貨單號（可做物流或對帳掃描）。</div>
</div>

<script>
const $=sel=>document.querySelector(sel);
const apiUrl = localStorage.getItem('API_URL') || '';
const token  = localStorage.getItem('API_TOKEN') || '';
const url = new URL(location.href);
const ship_id = url.searchParams.get('ship_id');
if(!ship_id){ document.body.innerHTML='<div class="p-3 text-danger">缺少 ship_id</div>'; throw new Error('no ship_id'); }
$('#back').href = 'shipping.html';

async function GET(params){
  params = params||{};
  if(token) params.token = token;
  const r = await fetch(apiUrl + '?' + new URLSearchParams(params).toString());
  return await r.json();
}
function num(v){ return Number(v||0); }

(async ()=>{
  const j = await GET({action:'shipment', ship_id});
  if(!j.ok) { document.body.innerHTML='<div class="p-3 text-danger">讀取失敗</div>'; return; }
  const h = j.header||{}, ls = j.lines||[];

  // Header
  $('#ship_id').textContent = ship_id;
  JsBarcode('#bc', ship_id, {format:'CODE128', width:2, height:40, displayValue:false, margin:0});

  $('#d_date').textContent   = h.ship_date || '';
  $('#d_vendor').textContent = h.vendor || '';
  $('#d_contact').textContent= h.contact || '';
  $('#d_phone').textContent  = h.phone || '';
  $('#d_addr').textContent   = h.address || '';
  $('#d_memo').textContent   = h.memo || '';

  // Lines
  const tb = $('#tb'); tb.innerHTML='';
  let sum=0;
  ls.forEach((l,i)=>{
    const amt = num(l.qty_out)*num(l.unit_price);
    sum += amt;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${i+1}</td>
      <td class="mono">${l.barcode||''}</td>
      <td class="mono">${l.code||''}</td>
      <td>${l.item||''}</td>
      <td>${l.spec||''}</td>
      <td class="mono">${l.loc||''}</td>
      <td>${l.exp||''}</td>
      <td class="num">${num(l.qty_out)}</td>
      <td class="num">${num(l.unit_price)}</td>
      <td class="num">${amt}</td>`;
    tb.appendChild(tr);
  });
  $('#t_sum').textContent = sum;
})();
</script>
</body>
</html>
